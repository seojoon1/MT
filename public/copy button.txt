import { Check, Heart, Plus, Settings, Trash2, Copy } from 'lucide-react' // [1] Added Copy icon
import { useEffect, useMemo, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { useTranslation } from 'react-i18next'
import { translateTag } from '../i18n/tagTranslations'
import type { Ment, MentStatus, BookmarkItem, MentItem } from '../types'
import { cn } from '../utils/cn'
import { SettingsModal } from '../components/modals'
import { getMentList, approveMent, rejectMent, getPendingMents, addBookmark, deleteBookmark, getMyBookmarks } from '../services/api'
import { isAdmin as checkIsAdmin } from '../storage/authStorage'
import { STORAGE_KEYS } from '../constants'

/**
 * @description
 * 애플리케이션의 메인 페이지로, '멘트(Ment)' 목록을 보여주는 대시보드 역할을 합니다.
 */
export default function MentListPage() {
  const navigate = useNavigate()
  const { t, i18n } = useTranslation()
  const [showSettings, setShowSettings] = useState(false)

  // --- 상태 관리 ---
  const [isAdmin, setIsAdminState] = useState<boolean>(false)
  const [originalIsAdmin, setOriginalIsAdmin] = useState<boolean>(false)
  const [selectedTag, setSelectedTag] = useState<string>('__all__')
  const [ments, setMentsState] = useState<Ment[]>([])
  const [bookmarks, setBookmarks] = useState<string[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [processingId, setProcessingId] = useState<string | null>(null)
  
  // [2] Added state to track copied item
  const [copiedId, setCopiedId] = useState<string | null>(null)

  useEffect(() => {
    const adminStatus = checkIsAdmin()
    setIsAdminState(adminStatus)
    setOriginalIsAdmin(adminStatus)
  }, [])

  function parseLaoText(contentLo: string): string {
    if (!contentLo) return ''
    try {
      const parsed = JSON.parse(contentLo)
      return  parsed.message || parsed.번역 || parsed.translation || contentLo
    } catch {
      return contentLo
    }
  }

  useEffect(() => {
    const fetchMentsAndBookmarks = async () => {
      setLoading(true)
      setError(null)
      try {
        const mentData = isAdmin ? await getPendingMents() : await getMentList()
        
        const convertedMents: Ment[] = mentData.map((item: MentItem) => ({
          id: String(item.mentId),
          ko: item.contentKo,
          lo: parseLaoText(item.contentLo || ''),
          tags: item.tag ? item.tag.split(',').map((t: string) => t.trim()) : [],
          aiHint: '',
          status: (item.isApproved === 1 ? 'approved' : 'pending') as MentStatus,
          createdAt: new Date(item.createdAt).getTime()
        }))
        setMentsState(convertedMents)
        
        if (!isAdmin) {
          try {
            const bookmarkData = await getMyBookmarks()
            const bookmarkIds = bookmarkData.map((item: BookmarkItem) => String((item as any).mentNum ?? (item as any).mentId)).filter(id => id && id !== 'undefined');
            setBookmarks(bookmarkIds)
            localStorage.setItem(STORAGE_KEYS.app.favorites, JSON.stringify(bookmarkIds))
          } catch (bookmarkErr) {
            console.error('북마크 목록 불러오기 실패:', bookmarkErr)
          }
        }
      } catch (err) {
        console.error('멘트 로딩 실패:', err)
        setError(err instanceof Error ? err.message : t('ment.loadingMentsFailed'))
      } finally {
        setLoading(false)
      }
    }
    
    fetchMentsAndBookmarks()
  }, [isAdmin, t])

  const availableTags = useMemo(() => {
    const pool = isAdmin ? ments : ments.filter((m) => m.status === 'approved')
    const tagSet = new Set<string>()
    for (const m of pool) for (const t of m.tags) tagSet.add(t)
    return Array.from(tagSet).sort((a, b) => a.localeCompare(b, 'ko'))
  }, [isAdmin, ments])

  const filteredMents = useMemo(() => {
    const base = isAdmin ? ments : ments.filter((m) => m.status === 'approved')
    if (selectedTag === '__all__') return base
    if (selectedTag === '__bookmarks__') {
      return base.filter((m) => bookmarks.includes(m.id))
    }
    return base.filter((m) => m.tags.includes(selectedTag))
  }, [isAdmin, ments, selectedTag, bookmarks])

  
  // --- 사용자 상호작용 핸들러 ---

  async function handleToggleBookmark(e: React.MouseEvent, id: string) {
    e.stopPropagation()
    const isBookmarked = bookmarks.includes(id)
    const mentId = Number(id)
    if (isNaN(mentId)) {
      setError(t('ment.invalidMentId'));
      return;
    }

    const newBookmarks = isBookmarked ? bookmarks.filter(bId => bId !== id) : [...bookmarks, id];
    
    try {
      if (isBookmarked) {
        await deleteBookmark(mentId)
      } else {
        await addBookmark(mentId)
      }
      
      setBookmarks(newBookmarks)
      localStorage.setItem(STORAGE_KEYS.app.favorites, JSON.stringify(newBookmarks))
      setError(null)
    } catch (err) {
      console.error(isBookmarked ? '북마크 삭제 실패:' : '북마크 추가 실패:', err)
      setError(err instanceof Error ? err.message : isBookmarked ? t('ment.bookmarkRemoveFailed') : t('ment.bookmarkAddFailed'))
    }
  }

  async function refetchAdminMents() {
    const data = await getPendingMents();
    const convertedMents: Ment[] = data.map((item: MentItem) => ({
      id: String(item.mentId), 
      ko: item.contentKo, 
      lo: parseLaoText(item.contentLo || ''),
      tags: item.tag ? item.tag.split(',').map((t: string) => t.trim()) : [], 
      aiHint: '',
      status: (item.isApproved === 1 ? 'approved' : 'pending') as MentStatus,
      createdAt: new Date(item.createdAt).getTime()
    }));
    setMentsState(convertedMents);
    setError(null);
  }

  async function handleApprove(e: React.MouseEvent, id: string, mentId: number) {
    e.stopPropagation()
    setProcessingId(id)
    try {
      await approveMent(mentId)
      await refetchAdminMents()
    } catch (err) {
      setError(err instanceof Error ? err.message : t('ment.approveFailed'))
    } finally {
      setProcessingId(null)
    }
  }

  async function handleRejectConfirm(e: React.MouseEvent, id: string, mentId: number) {
    e.stopPropagation()
    setProcessingId(id)
    try {
      await rejectMent(mentId)
      await refetchAdminMents()
    } catch (err) {
      setError(err instanceof Error ? err.message : t('ment.rejectFailed'))
    } finally {
      setProcessingId(null)
    }
  }

  // [3] Added Handle Copy Function
  const handleCopy = (e: React.MouseEvent, text: string, id: string) => {
    e.stopPropagation(); // Prevents navigating to the detail page
    navigator.clipboard.writeText(text).then(() => {
      setCopiedId(id);
      setTimeout(() => setCopiedId(null), 2000);
    });
  };

  // --- 렌더링 ---
  return (
    <div className="h-full bg-gradient-to-b from-pink-50 to-purple-50">
      <div className="mx-auto flex h-full max-w-[480px] flex-col">
        {/* 헤더 */}
        <header className="sticky top-0 z-10 border-b border-pink-100 bg-gradient-to-b from-pink-50/90 to-purple-50/70 px-4 pb-3 pt-4 backdrop-blur">
          <div className="flex items-center justify-between gap-3">
            <div className="min-w-0">
              <h1 className="truncate text-lg font-semibold text-slate-900">{t('common.appName')}</h1>
              <p className="text-xs text-slate-500">{isAdmin ? t('ment.adminMode') : t('ment.userMode')}</p>
            </div>
            <div className="flex items-center gap-2">
              <button type="button" onClick={() => setShowSettings(true)} className="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-pink-200 bg-white text-slate-700" aria-label="설정">
                <Settings className="h-5 w-5" />
              </button>
              {originalIsAdmin && (
                <button type="button" onClick={() => setIsAdminState((v) => !v)} className={cn('h-10 w-10 rounded-xl border flex items-center justify-center text-xs font-bold', isAdmin ? 'border-purple-300 bg-purple-600 text-white' : 'border-pink-300 bg-pink-50 text-pink-700')} aria-label={isAdmin ? '어드민 모드' : '유저 모드'}>
                  {isAdmin ? 'A' : 'U'}
                </button>
              )}
            </div>
          </div>
          {/* 태그 필터링 UI */}
          <div className="mt-3">
            <div className="flex gap-2 overflow-x-auto pb-1 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
              <button type="button" onClick={() => setSelectedTag('__all__')} className={cn('h-10 shrink-0 rounded-full border px-4 text-sm font-medium', selectedTag === '__all__' ? 'border-purple-200 bg-purple-600 text-white' : 'border-pink-200 bg-white text-slate-700')}>
                {t('ment.all')}
              </button>
              {!isAdmin && (
                <button type="button" onClick={() => setSelectedTag('__bookmarks__')} className={cn('flex h-10 shrink-0 items-center gap-1 rounded-full border px-4 text-sm font-medium', selectedTag === '__bookmarks__' ? 'border-pink-600 bg-pink-600 text-white' : 'border-pink-200 bg-white text-slate-700')}>
                  <Heart className={cn('h-4 w-4', selectedTag === '__bookmarks__' && 'fill-white')} />
                  {t('ment.bookmarks')}
                </button>
              )}
              {availableTags.map((tag) => (
                <button key={tag} type="button" onClick={() => setSelectedTag(tag)} className={cn('h-10 shrink-0 rounded-full border px-4 text-sm font-medium', selectedTag === tag ? 'border-purple-200 bg-purple-600 text-white' : 'border-pink-200 bg-white text-slate-700')}>
                  #{translateTag(tag, i18n.language as 'ko' | 'lo')}
                </button>
              ))}
            </div>
          </div>
        </header>

        {/* 메인 콘텐츠 */}
        <main className="flex-1 overflow-y-auto px-4 pb-6 pt-4">
          {loading ? (
            <div className="rounded-2xl border border-pink-100 bg-white p-4 text-sm text-slate-600 shadow-sm text-center">{t('ment.loadingMents')}</div>
          ) : error ? (
            <div className="rounded-2xl border border-red-100 bg-red-50 p-4 text-sm text-red-600 shadow-sm">{error}</div>
          ) : filteredMents.length === 0 ? (
            <div className="rounded-2xl border border-pink-100 bg-white p-4 text-sm text-slate-600 shadow-sm">{t('ment.noMents')}</div>
          ) : (
            <div className="space-y-3">
              {filteredMents.map((m) => {
                const isPending = m.status === 'pending'
                const isBookmarked = bookmarks.includes(m.id)
                return (
                  <div key={m.id} role="button" tabIndex={0} onClick={() => !isAdmin && navigate(`/ments/${m.id}`)} onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') !isAdmin && navigate(`/ments/${m.id}`) }} className={cn('rounded-2xl border bg-white p-4 shadow-sm', 'border-pink-100')}>
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0 flex-1">
                        <p className="text-base font-semibold text-slate-900">{m.ko}</p>
                        <p className="mt-1 text-sm text-slate-500">{m.lo}</p>

                        {/* [4] Inserted Copy Button Here */}
                        <button
                          type="button"
                          onClick={(e) => handleCopy(e, m.lo, m.id)}
                          className="mt-2 flex items-center gap-1.5 text-xs text-slate-400 hover:text-pink-600 transition-colors w-fit"
                        >
                          {copiedId === m.id ? (
                            <>
                              <Check className="h-3.5 w-3.5" />
                              <span className="font-medium">Copied!</span>
                            </>
                          ) : (
                            <>
                              <Copy className="h-3.5 w-3.5" />
                              <span>Copy</span>
                            </>
                          )}
                        </button>

                        <div className="mt-3 flex flex-wrap gap-2">
                          {m.tags.map((t) => (
                            <span key={t} className="rounded-full bg-pink-50 px-3 py-1 text-xs font-medium text-pink-700">
                              #{translateTag(t, i18n.language as 'ko' | 'lo')}
                            </span>
                          ))}
                          {isAdmin && (
                            <span className={cn('rounded-full px-3 py-1 text-xs font-semibold', m.status === 'approved' && 'bg-green-50 text-green-700', isPending && 'bg-purple-50 text-purple-700', m.status === 'rejected' && 'bg-slate-100 text-slate-600')}>
                              {m.status}
                            </span>
                          )}
                        </div>
                      </div>
                      {!isAdmin && (
                        <button type="button" aria-label="북마크" onClick={(e) => handleToggleBookmark(e, m.id)} className={cn('inline-flex h-11 w-11 items-center justify-center rounded-xl border shrink-0', isBookmarked ? 'border-pink-200 bg-pink-50 text-pink-600' : 'border-pink-200 bg-white text-slate-500')}>
                          <Heart className={cn('h-5 w-5', isBookmarked && 'fill-pink-600')} />
                        </button>
                      )}
                    </div>
                    {isAdmin && isPending && (
                      <div className="mt-4 flex gap-2">
                        <button type="button" onClick={(e) => handleApprove(e, m.id, Number(m.id))} disabled={processingId === m.id} className="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl bg-purple-600 text-sm font-semibold text-white disabled:opacity-50">
                          <Check className="h-5 w-5" />
                          {processingId === m.id ? t('common.loading') : t('ment.approve')}
                        </button>
                        <button type="button" onClick={(e) => handleRejectConfirm(e, m.id, Number(m.id))} disabled={processingId === m.id} className="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl border border-pink-200 bg-white text-sm font-semibold text-slate-700 disabled:opacity-50">
                          <Trash2 className="h-5 w-5" />
                          {processingId === m.id ? t('common.loading') : t('ment.reject')}
                        </button>
                      </div>
                    )}
                  </div>
                )
              })}
            </div>
          )}
        </main>
      </div>

      {!isAdmin && (
        <button type="button" onClick={() => navigate('/ments/new')} className="fixed bottom-6 right-6 z-20 inline-flex h-14 w-14 items-center justify-center rounded-full bg-pink-600 text-white shadow-lg hover:bg-pink-700 active:scale-95 transition-transform" aria-label="멘트 추가">
          <Plus className="h-6 w-6" />
        </button>
      )}

      <SettingsModal 
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
      />
    </div>
  )
}